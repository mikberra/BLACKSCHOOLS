<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Clean Blog - Start Bootstrap Theme</title>
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
        <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
        <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
        <style>
            body {
                background: url('../images/background.png') no-repeat center center fixed;
                background-size: cover; 
                margin: 0; 
                padding: 0; 
            }
          </style>
        <!-- Navigation bar script -->
        <script src="navbar.js"></script>
    </head>
    <body>
<!-- Masthead-->
    <div class="container-fluid px-0">
        <div class="row g-0 text-white">
            <!-- Left Column: 7/12 wide -->
            <div class="col-md-7 position-relative">
                <!-- Masthead Section -->
                <img class="masthead-overlay" id="school.description.image" style="height: 80vh; width: 100%; object-fit: cover;">
                <div class="text-overlay p-4" style="position: absolute; bottom: 0; left: 0; z-index: 1;">
                    <h4 id="school.address"></h4>
                    <t1 id="school.name"></t1>
                </div>
            </div>
            <!-- Right Column: 5/12 wide -->
            <div class="col-md-5 position-relative">
                <!-- Mapbox Map as Background -->
                <div id="map" class="map-schools"></div>
                <script src="map.js"></script>
            </div>
        </div>
    </div>
<!-- Info-->
    <div class="container-fluid px-0">
        <div class="row g-0 bg-dark text-white">
            <!-- Left Column: 7/12 wide -->
            <div class="col-md-7">
                <!-- Description Section -->
                <div class="p-4">
                        <div class="mb-4">
                            <t3>Summary</t3>
                            <p id="school.description.briefDescription"></p>
                        </div>
                    <div>
                        <t3>Notable People</t3>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="avatar-card">
                                    <img class="avatar" id="relevantFigures.figure1.image">
                                    <div class="avatar-text-content">
                                        <h5 id="relevantFigures.figure1.name" class="avatar-name"></h5>
                                        <p id="relevantFigures.figure1.role" class="avatar-title"></p>
                                        <p id="relevantFigures.figure1.briefDescription" class="avatar-description"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Right Column: 5/12 wide -->
            <div class="col-md-5">   
            <!-- First Row -->
                <div class="row">
                    <!-- First Row, First Column: Current condition -->
                    <div class="col-6">
                        <div class="p-4">
                            <t3>Current condition</t3>
                            <div class="extra-small-text">
                                <p class="my-0 py-0" id="school.currentUse">Current use: <span></span></p>
                                <p class="my-0 py-0" id="school.condition">Current condition: <span></span></p>
                                <p class="my-0 py-0" id="school.landmarked">Is it landmarked? <span></span></p>
                                <p class="my-0 py-0" id="school.landmarkedBy">By who? <span></span></p>
                                <p class="my-0 py-0" id="school.sign">Is there a sign? <span></span></p>
                                <p class="my-0 py-0" id="school.owner">Who owns the building? <span></span></p>
                            </div>
                        </div>
                    </div>
                    <!-- First Row, Second Column: Contributors -->
                    <div class="col-6">
                        <div class="p-4">
                            <t3>Contributors</t3>
                            <div class="extra-small-text">
                                <p class="my-0 py-0" id="contacts.contributors.contributor1.organization"><span></span></p>
                                <p class="my-0 py-0" id="contacts.contributors.contributor2.organization"><span></span></p>
                                <p class="my-0 py-0" id="contacts.contributors.contributor3.organization"><span></span></p>
                                <p class="my-0 py-0" id="contacts.contributors.contributor4.organization"><span></span></p>
                                <p class="my-0 py-0" id="contacts.contributors.contributor5.organization"><span></span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Second Row -->
                <div class="row">
                    <!-- Second Row, First Column: Quick dates -->
                    <div class="col-6">
                        <div class="p-4">
                            <t3>Quick dates</t3>
                            <div class="extra-small-text">
                                <p class="my-0 py-0" id="school.description.yearInstitutionCreation">Year of creation: <span></span></p>
                                <p class="my-0 py-0" id="school.description.yearBuildingStarted">Building started: <span></span></p>
                                <p class="my-0 py-0" id="school.description.yearBuildingEnded">Building ended: <span></span></p>
                                <p class="my-0 py-0" id="school.description.yearDesegregation">Desegregation: <span></span></p>
                                <p class="my-0 py-0" id="school.description.yearCeased">School ceased: <span></span></p>
                                <p class="my-0 py-0" id="school.description.yearDemolished">Building demolished: <span></span></p>
                            </div>
                        </div>
                    </div>
                    <!-- Second Row, Second Column: Names over time -->
                    <div class="col-6">
                        <div class="p-4">
                            <t3>Names over time</t3>
                            <div class="extra-small-text">
                                <p class="my-0 py-0" id="school.otherNames.name1"></p>
                                <p class="my-0 py-0" id="school.otherNames.name2"></p>
                                <p class="my-0 py-0" id="school.otherNames.name3"></p>
                                <p class="my-0 py-0" id="school.otherNames.name4"></p>
                                <p class="my-0 py-0" id="school.otherNames.name5"></p>
                            </div>
                        </div>
                    </div>
                </div>
         </div>
    </div>

<!-- Timeline-->
<article class="bg-white">
    <div class="container-fluid px-4 pt-4 pb-2 px-lg-5">
        <div class="row">
            <t1>Timeline</t1>
        </div>
    </div>
</article>
<div class="row sticky-top-buttons mb-2">
    <div class="col-md-7"><h4>School Events</h4></div>  <!-- Empty left column to push content right -->
    <div class="col-md-5 sticky-top-buttons">
        <button id="buttonA" class="active" onclick="toggleContent('A')">Maps</button>
        <button id="buttonB" onclick="toggleContent('B')">Historical context</button>
    </div>
</div>

<!-- Decade 1 -->
<div id="timeline-container" class="container pt-2"></div>

<!-- Sources -->


<!-- Footer -->
<script src="footer.js"></script>


<!-- Components-->   
    <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Core theme JS-->
        <script src="js/scripts.js"></script>    
    <!-- On-off button -->    
        <script>
            function toggleContent(content) {
                // Select all content elements
                const contentAElements = document.querySelectorAll('.contentA');
                const contentBElements = document.querySelectorAll('.contentB');
                
                // Select the buttons
                const buttonA = document.getElementById('buttonA');
                const buttonB = document.getElementById('buttonB');
        
                if (content === 'A') {
                    contentAElements.forEach(el => el.classList.remove('d-none'));
                    contentBElements.forEach(el => el.classList.add('d-none'));
                    buttonA.classList.add('active');
                    buttonB.classList.remove('active');
                } else if (content === 'B') {
                    contentAElements.forEach(el => el.classList.add('d-none'));
                    contentBElements.forEach(el => el.classList.remove('d-none'));
                    buttonA.classList.remove('active');
                    buttonB.classList.add('active');
                }
            }
        </script>


    <!-- Timeline elements script -->
        <script>
            const decades = 10; // Number of decades
            const container = document.getElementById("timeline-container");

            for (let i = 1; i <= decades; i++) {
                const html = `
                    <div class="row gx-4 gx-lg-5">
                        <!-- School event -->
                        <div class="col-md-7">
                            <section>
                                <div class="row align-items-center">
                                    <div class="col-md-2">
                                        <h3 id="school.timeline.event${i}.year" class="event-year"></h3>
                                    </div>
                                    <div class="col-md-10">
                                        <h2 id="school.timeline.event${i}.title"></h2>
                                    </div>
                                </div>
                                <div class="col-md-1"></div>
                                <div class="col-md-11 timeline-box">
                                    <p id="school.timeline.event${i}.briefDescription"></p>
                                    <p id="school.timeline.event${i}.sources"></p>
                                    <img id="school.timeline.event${i}.image" class="img-fluid" style="max-height: 50vh"/>
                                    <p id="school.timeline.event${i}.footnote"></p>
                                    <p id="school.timeline.event${i}.imageSources"></p>
                                </div>
                            </section>
                        </div>

                        <!-- Context map and event -->
                        <div class="col-md-5">
                            <!-- Context map -->
                            <div class="contentA mt-3">
                                <section class="parallax">
                                    <img id="maps.map${i}.image" class="img-fluid" style="display: none;">
                                </section>
                            </div>
                            <!-- Context event -->
                            <div class="contentB mt-3 d-none text-dark">
                                <section>
                                    <div class="row align-items-center">
                                        <div class="col-md-2">
                                            <h4 id="ctxt.timeline.event${i}.year"></h4>
                                        </div>
                                        <div class="col-md-10">
                                            <h3 id="ctxt.timeline.event${i}.title"></h3>
                                        </div>
                                    </div>
                                    <div class="timeline-box">
                                        <p id="ctxt.timeline.event${i}.briefDescription"></p>
                                        <p id="ctxt.timeline.event${i}.sources"></p>
                                        <img id="ctxt.timeline.event${i}.image" class="img-fluid" />
                                        <p id="ctxt.timeline.event${i}.footnote"></p>
                                        <p id="ctxt.timeline.event${i}.imageSources"></p>
                                    </div>
                                </section>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            }
        </script>

    <!-- Pulling all info script -->
        <script>
            window.onload = async function () {
                // Get the schoolId from the URL path
                const pathParts = window.location.pathname.split('/');
                const schoolId = pathParts[pathParts.length - 1]; // Gets the last part of the URL path
                const contextId = "6755f8497dc1fb8687a92dfb";

                if (!schoolId) {
                    console.error('No school ID found in URL');
                    return;
                }

                console.log('Loading school data for ID:', schoolId);
                await fetchData(schoolId, contextId);
            };

            async function fetchData(schoolId, contextId) {
                const schoolApiUrl = '/api/formdata';
                const contextApiUrl = '/api/formdata_context';

                try {
                    // Fetch school data
                    const schoolResponse = await fetch(schoolApiUrl);
                    if (!schoolResponse.ok) throw new Error("Failed to fetch school data.");
                    const schoolData = await schoolResponse.json();
                    const schoolEntry = schoolData.find(item => item._id === schoolId);

                    // Fetch context data
                    const contextResponse = await fetch(contextApiUrl);
                    if (!contextResponse.ok) throw new Error("Failed to fetch context data.");
                    const contextData = await contextResponse.json();
                    const contextEntry = contextData.find(item => item._id === contextId);

                    // Update the DOM with fetched data
                    updateData(schoolEntry, contextEntry);
                } catch (error) {
                    console.error("Error fetching data:", error);
                }
            }

            function updateData(schoolEntry, contextEntry) {
                // Update or hide elements
                function updateOrHide(id, value, isImage = false) {
                    const element = document.getElementById(id);
                    if (element) {
                        if (value && value !== 'null' && value !== 'undefined') {
                            if (isImage) {
                                element.src = value;
                                element.style.display = 'block';
                            } else {
                                // Check if there's a span element
                                const span = element.querySelector('span');
                                if (span) {
                                    span.textContent = value;
                                } else {
                                    // If no span, append to existing text
                                    element.textContent += ` ${value}`;
                                }
                                element.style.display = '';
                            }
                        } else {
                            // Hide the entire element (including label) if value is null/undefined/empty
                            element.style.display = 'none';
                        }
                    } else {
                        console.log(`Element not found: ${id}`); // Debug log
                    }
                }

                if (schoolEntry) {
                    // Add debug logging
                    console.log('School entry:', schoolEntry);
                    
                    // For the main school image
                    if (schoolEntry.school?.description?.image) {
                        console.log('School image path:', schoolEntry.school.description.image);
                    }

                    // General Information (non-image updates)
                    updateOrHide('generalInformation.areaOfWork', schoolEntry.generalInformation?.areaOfWork);
                    updateOrHide('generalInformation.city', schoolEntry.generalInformation?.city);
                    updateOrHide('generalInformation.county', schoolEntry.generalInformation?.county);
                    updateOrHide('generalInformation.neighborhood', schoolEntry.generalInformation?.neighborhood);
                    updateOrHide('generalInformation.state', schoolEntry.generalInformation?.state);

                    // School Details (non-image updates)
                    updateOrHide('school.name', schoolEntry.school?.name);
                    updateOrHide('school.address', schoolEntry.school?.address);
                    updateOrHide('school.condition', schoolEntry.school?.condition);
                    updateOrHide('school.description.briefDescription', schoolEntry.school?.description?.briefDescription);

                    // Images - Note the isImage flag set to true
                    updateOrHide('school.description.image', schoolEntry.school?.description?.image, true);

                    // Timeline Events
                    for (let i = 1; i <= 10; i++) {
                        updateOrHide(`school.timeline.event${i}.title`, schoolEntry.school?.timeline[`event${i}`]?.title);
                        updateOrHide(`school.timeline.event${i}.year`, schoolEntry.school?.timeline[`event${i}`]?.year);
                        updateOrHide(`school.timeline.event${i}.briefDescription`, schoolEntry.school?.timeline[`event${i}`]?.briefDescription);
                        updateOrHide(`school.timeline.event${i}.sources`, schoolEntry.school?.timeline[`event${i}`]?.sources);
                        updateOrHide(`school.timeline.event${i}.footnote`, schoolEntry.school?.timeline[`event${i}`]?.footnote);
                        updateOrHide(`school.timeline.event${i}.image`, schoolEntry.school?.timeline[`event${i}`]?.image, true);
                        updateOrHide(`school.timeline.event${i}.imageSources`, schoolEntry.school?.timeline[`event${i}`]?.imageSources);
                    }

                    // Relevant Figures
                    for (let i = 1; i <= 5; i++) {
                        updateOrHide(`relevantFigures.figure${i}.name`, schoolEntry.relevantFigures?.[`figure${i}`]?.name);
                        updateOrHide(`relevantFigures.figure${i}.role`, schoolEntry.relevantFigures?.[`figure${i}`]?.role);
                        updateOrHide(`relevantFigures.figure${i}.briefDescription`, schoolEntry.relevantFigures?.[`figure${i}`]?.briefDescription);
                        updateOrHide(`relevantFigures.figure${i}.image`, schoolEntry.relevantFigures?.[`figure${i}`]?.image, true);
                    }

                    // Maps
                    console.log('Full schoolEntry:', schoolEntry);
                    console.log('Maps data:', schoolEntry.maps);
                    
                    // Maps update with detailed logging
                    for (let i = 1; i <= 10; i++) {
                        console.log(`Checking map${i}:`, schoolEntry.maps?.[`map${i}`]);
                        const mapImage = schoolEntry.maps?.[`map${i}`]?.image;
                        console.log(`Map ${i} image value:`, mapImage);
                        
                        if (mapImage) {
                            const imageUrl = mapImage.startsWith('http') ? mapImage : `https://res.cloudinary.com/ddsuauehz/image/upload/${mapImage}`;
                            console.log(`Processing map ${i} with URL:`, imageUrl);
                            updateOrHide(`maps.map${i}.image`, imageUrl, true);
                        }
                    }

                    // Update current condition section
                    updateOrHide('school.currentUse', schoolEntry.school?.currentUse);
                    updateOrHide('school.condition', schoolEntry.school?.condition);
                    updateOrHide('school.landmarked', schoolEntry.school?.landmarked);
                    updateOrHide('school.landmarkedBy', schoolEntry.school?.landmarkedBy);
                    updateOrHide('school.sign', schoolEntry.school?.sign);
                    updateOrHide('school.owner', schoolEntry.school?.owner);

                    // Update quick dates section
                    updateOrHide('school.description.yearInstitutionCreation', schoolEntry.school?.description?.yearInstitutionCreation);
                    updateOrHide('school.description.yearBuildingStarted', schoolEntry.school?.description?.yearBuildingStarted);
                    updateOrHide('school.description.yearBuildingEnded', schoolEntry.school?.description?.yearBuildingEnded);
                    updateOrHide('school.description.yearDesegregation', schoolEntry.school?.description?.yearDesegregation);
                    updateOrHide('school.description.yearCeased', schoolEntry.school?.description?.yearCeased);
                    updateOrHide('school.description.yearDemolished', schoolEntry.school?.description?.yearDemolished);

                    // Update names over time section
                    updateOrHide('school.otherNames.name1', schoolEntry.school?.otherNames?.name1);
                    updateOrHide('school.otherNames.name2', schoolEntry.school?.otherNames?.name2);
                    updateOrHide('school.otherNames.name3', schoolEntry.school?.otherNames?.name3);
                    updateOrHide('school.otherNames.name4', schoolEntry.school?.otherNames?.name4);
                    updateOrHide('school.otherNames.name5', schoolEntry.school?.otherNames?.name5);
                }

                if (contextEntry) {
                    // Context Information
                    updateOrHide('ctxt.generalInformation.areaOfWork', contextEntry.generalInformation?.areaOfWork);
                    updateOrHide('ctxt.generalInformation.city', contextEntry.generalInformation?.city);
                    updateOrHide('ctxt.generalInformation.county', contextEntry.generalInformation?.county);
                    updateOrHide('ctxt.generalInformation.neighborhood', contextEntry.generalInformation?.neighborhood);
                    updateOrHide('ctxt.generalInformation.state', contextEntry.generalInformation?.state);

                    // Context Timeline
                    for (let i = 1; i <= 10; i++) {
                        updateOrHide(`ctxt.timeline.event${i}.title`, contextEntry.timeline?.[`event${i}`]?.title);
                        updateOrHide(`ctxt.timeline.event${i}.year`, contextEntry.timeline?.[`event${i}`]?.year);
                        updateOrHide(`ctxt.timeline.event${i}.briefDescription`, contextEntry.timeline?.[`event${i}`]?.briefDescription);
                        updateOrHide(`ctxt.timeline.event${i}.sources`, contextEntry.timeline?.[`event${i}`]?.sources);
                        updateOrHide(`ctxt.timeline.event${i}.image`, contextEntry.timeline?.[`event${i}`]?.image, true);
                    }
                }
            }
        </script>  
    </body>
</html>